<!--pages/workout/workout.wxml-->
<view class="workout-container">
  <!-- æ ‡ç­¾åˆ‡æ¢ -->
  <view class="tab-bar">
    <view class="tab-item {{currentTab === 'plans' ? 'active' : ''}}"
          bindtap="switchTab"
          data-tab="plans">
      è®­ç»ƒè®¡åˆ’
    </view>
    <view class="tab-item {{currentTab === 'history' ? 'active' : ''}}"
          bindtap="switchTab"
          data-tab="history">
      è®­ç»ƒå†å²
    </view>
  </view>

  <!-- è®­ç»ƒè®¡åˆ’é¡µé¢ -->
  <view class="tab-content" wx:if="{{currentTab === 'plans'}}">
    <!-- æ–°å»ºè®¡åˆ’æŒ‰é’® -->
    <view class="create-btn" bindtap="showCreatePlan">
      <text class="icon">+</text>
      <text class="text">åˆ›å»ºè®­ç»ƒè®¡åˆ’</text>
    </view>

    <!-- è®¡åˆ’åˆ—è¡¨ -->
    <view class="plan-list">
      <view class="plan-card"
            wx:for="{{workoutPlans}}"
            wx:key="_id">

        <!-- è®¡åˆ’å¤´éƒ¨ -->
        <view class="plan-header">
          <text class="plan-name">{{item.name}}</text>
          <view class="plan-actions">
            <text class="action-btn delete-btn"
                  bindtap="deletePlan"
                  data-id="{{item._id}}"
                  data-name="{{item.name}}">åˆ é™¤</text>
          </view>
        </view>

        <!-- è®¡åˆ’è¯¦æƒ… -->
        <view class="plan-body">
          <view class="exercise-item" wx:for="{{item.exercises}}" wx:key="index" wx:for-item="exercise">
            <view class="exercise-info">
              <text class="exercise-name">{{exercise.name}}</text>
              <text class="exercise-detail">{{exercise.sets}}ç»„ Ã— {{exercise.reps}}æ¬¡</text>
              <text class="exercise-detail" wx:if="{{exercise.weight > 0}}">{{exercise.weight}}kg</text>
            </view>
          </view>
        </view>

        <!-- å¼€å§‹è®­ç»ƒæŒ‰é’® -->
        <view class="plan-footer">
          <button class="start-btn"
                  bindtap="startWorkout"
                  data-plan="{{item}}">å¼€å§‹è®­ç»ƒ</button>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{workoutPlans.length === 0}}">
        <text class="empty-icon">ğŸ’ª</text>
        <text class="empty-text">è¿˜æ²¡æœ‰è®­ç»ƒè®¡åˆ’</text>
        <text class="empty-hint">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªè®¡åˆ’</text>
      </view>
    </view>
  </view>

  <!-- æ–°å»ºè®¡åˆ’è¡¨å• -->
  <view class="create-plan-modal" wx:if="{{isCreatingPlan}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">åˆ›å»ºè®­ç»ƒè®¡åˆ’</text>
        <text class="modal-close" bindtap="cancelCreatePlan">Ã—</text>
      </view>

      <scroll-view class="modal-body" scroll-y>
        <!-- è®¡åˆ’åç§° -->
        <view class="form-item">
          <text class="form-label">è®¡åˆ’åç§°</text>
          <input class="form-input"
                 placeholder="ä¾‹å¦‚ï¼šèƒ¸è‚Œè®­ç»ƒ"
                 value="{{newPlan.name}}"
                 bindinput="updatePlanName" />
        </view>

        <!-- åŠ¨ä½œåˆ—è¡¨ -->
        <view class="exercises-section">
          <text class="section-title">è®­ç»ƒåŠ¨ä½œ</text>

          <view class="exercise-form"
                wx:for="{{newPlan.exercises}}"
                wx:key="index">

            <view class="exercise-form-header">
              <text class="exercise-number">åŠ¨ä½œ {{index + 1}}</text>
              <text class="exercise-delete"
                    bindtap="deleteExercise"
                    data-index="{{index}}"
                    wx:if="{{newPlan.exercises.length > 1}}">åˆ é™¤</text>
            </view>

            <!-- åŠ¨ä½œåç§° -->
            <view class="form-row">
              <text class="field-label">åŠ¨ä½œåç§°</text>
              <input class="form-input"
                     placeholder="ä¾‹å¦‚ï¼šå§æ¨"
                     value="{{item.name}}"
                     bindinput="updateExercise"
                     data-field="name"
                     data-index="{{index}}" />
            </view>

            <!-- ç»„æ•°ã€æ¬¡æ•°ã€é‡é‡ -->
            <view class="form-row-group">
              <view class="form-row-small">
                <text class="field-label">ç»„æ•°</text>
                <input class="form-input-small"
                       type="number"
                       value="{{item.sets}}"
                       bindinput="updateExercise"
                       data-field="sets"
                       data-index="{{index}}" />
              </view>

              <view class="form-row-small">
                <text class="field-label">æ¬¡æ•°</text>
                <input class="form-input-small"
                       type="number"
                       value="{{item.reps}}"
                       bindinput="updateExercise"
                       data-field="reps"
                       data-index="{{index}}" />
              </view>

              <view class="form-row-small">
                <text class="field-label">é‡é‡(kg)</text>
                <input class="form-input-small"
                       type="digit"
                       value="{{item.weight}}"
                       bindinput="updateExercise"
                       data-field="weight"
                       data-index="{{index}}" />
              </view>
            </view>
          </view>

          <!-- æ·»åŠ åŠ¨ä½œæŒ‰é’® -->
          <view class="add-exercise-btn" bindtap="addExercise">
            <text class="add-icon">+</text>
            <text class="add-text">æ·»åŠ åŠ¨ä½œ</text>
          </view>
        </view>
      </scroll-view>

      <view class="modal-footer">
        <button class="cancel-btn" bindtap="cancelCreatePlan">å–æ¶ˆ</button>
        <button class="save-btn" bindtap="savePlan">ä¿å­˜</button>
      </view>
    </view>
  </view>

  <!-- è®­ç»ƒè¿›è¡Œä¸­é¡µé¢ -->
  <view class="workout-progress" wx:if="{{currentTab === 'workout' && currentWorkout}}">
    <!-- è®­ç»ƒå¤´éƒ¨ -->
    <view class="workout-header">
      <view class="workout-info">
        <text class="workout-plan-name">{{currentWorkout.planName}}</text>
        <text class="workout-timer">{{formatDuration(workoutDuration)}}</text>
      </view>
      <button class="give-up-btn" bindtap="giveUpWorkout">æ”¾å¼ƒè®­ç»ƒ</button>
    </view>

    <!-- å½“å‰åŠ¨ä½œ -->
    <view class="current-exercise">
      <view class="exercise-header">
        <text class="exercise-index">åŠ¨ä½œ {{currentExerciseIndex + 1}}/{{currentWorkout.exercises.length}}</text>
      </view>

      <view class="exercise-content">
        <text class="exercise-name">{{currentWorkout.exercises[currentExerciseIndex].name}}</text>
        <view class="exercise-stats">
          <text class="stat-item">
            <text class="stat-label">ç»„æ•°</text>
            <text class="stat-value">{{currentWorkout.exercises[currentExerciseIndex].completedSets}}/{{currentWorkout.exercises[currentExerciseIndex].sets}}</text>
          </text>
          <text class="stat-item">
            <text class="stat-label">æ¬¡æ•°</text>
            <text class="stat-value">{{currentWorkout.exercises[currentExerciseIndex].reps}}</text>
          </text>
          <text class="stat-item" wx:if="{{currentWorkout.exercises[currentExerciseIndex].weight > 0}}">
            <text class="stat-label">é‡é‡</text>
            <text class="stat-value">{{currentWorkout.exercises[currentExerciseIndex].weight}}kg</text>
          </text>
        </view>
      </view>
    </view>

    <!-- å®Œæˆç»„æŒ‰é’® -->
    <view class="complete-set-section">
      <button class="complete-set-btn"
              bindtap="completeSet"
              data-exercise-index="{{currentExerciseIndex}}">
        å®Œæˆç¬¬ {{currentSetIndex + 1}} ç»„
      </button>
    </view>

    <!-- å‰©ä½™åŠ¨ä½œé¢„è§ˆ -->
    <view class="remaining-exercises">
      <text class="section-title">å‰©ä½™åŠ¨ä½œ</text>
      <scroll-view class="exercises-list" scroll-y>
        <view class="remaining-item"
              wx:for="{{currentWorkout.exercises}}"
              wx:key="index"
              wx:if="{{index > currentExerciseIndex}}">
          <text class="remaining-name">{{item.name}}</text>
          <text class="remaining-detail">{{item.sets}}ç»„ Ã— {{item.reps}}æ¬¡</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- è®­ç»ƒå†å²é¡µé¢ -->
  <view class="tab-content" wx:if="{{currentTab === 'history'}}">
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <view class="stats-cards">
      <view class="stat-card">
        <text class="stat-value">{{totalWorkouts}}</text>
        <text class="stat-label">æ€»è®­ç»ƒæ¬¡æ•°</text>
      </view>
      <view class="stat-card">
        <text class="stat-value">{{weekWorkouts}}</text>
        <text class="stat-label">æœ¬å‘¨è®­ç»ƒ</text>
      </view>
    </view>

    <!-- å†å²è®°å½•åˆ—è¡¨ -->
    <view class="history-list">
      <view class="history-item"
            wx:for="{{workoutHistory}}"
            wx:key="_id"
            bindtap="viewWorkoutDetail"
            data-log="{{item}}">

        <view class="history-header">
          <text class="history-plan">{{item.planName}}</text>
          <text class="history-date">{{item.startTime}}</text>
        </view>

        <view class="history-body">
          <text class="history-duration">{{item.duration}}ç§’</text>
          <text class="history-exercises">{{item.exercises.length}}ä¸ªåŠ¨ä½œ</text>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{workoutHistory.length === 0}}">
        <text class="empty-icon">ğŸ“Š</text>
        <text class="empty-text">è¿˜æ²¡æœ‰è®­ç»ƒè®°å½•</text>
        <text class="empty-hint">å¼€å§‹ç¬¬ä¸€æ¬¡è®­ç»ƒå§ï¼</text>
      </view>
    </view>
  </view>
</view>
