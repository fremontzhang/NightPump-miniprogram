<!--pages/bodydata/bodydata.wxml-->
<view class="bodydata-container">
  <!-- æ ‡ç­¾åˆ‡æ¢ -->
  <view class="tab-bar">
    <view class="tab-item {{currentTab === 'overview' ? 'active' : ''}}"
          bindtap="switchTab"
          data-tab="overview">
      æ¦‚è§ˆ
    </view>
    <view class="tab-item {{currentTab === 'history' ? 'active' : ''}}"
          bindtap="switchTab"
          data-tab="history">
      å†å²
    </view>
  </view>

  <!-- æ¦‚è§ˆé¡µé¢ -->
  <view class="tab-content" wx:if="{{currentTab === 'overview'}}">
    <!-- æ·»åŠ æ•°æ®æŒ‰é’® -->
    <view class="add-btn" bindtap="showAddForm">
      <text class="icon">+</text>
      <text class="text">è®°å½•èº«ä½“æ•°æ®</text>
    </view>

    <!-- æœ€æ–°æ•°æ®å¡ç‰‡ -->
    <view class="latest-data-card" wx:if="{{latestData}}">
      <view class="card-header">
        <text class="card-title">æœ€æ–°æ•°æ®</text>
        <text class="card-date">{{latestData.date}}</text>
      </view>

      <view class="data-grid">
        <!-- ä½“é‡ -->
        <view class="data-item">
          <text class="data-label">ä½“é‡</text>
          <text class="data-value">{{latestData.weight || '--'}} kg</text>
        </view>

        <!-- BMI -->
        <view class="data-item">
          <text class="data-label">BMI</text>
          <text class="data-value"
                style="color: {{getBMIStatusColor(calculateBMI(latestData.weight, latestData.height))}}">
            {{calculateBMI(latestData.weight, latestData.height) || '--'}}
          </text>
        </view>

        <!-- ä½“è„‚ç‡ -->
        <view class="data-item">
          <text class="data-label">ä½“è„‚ç‡</text>
          <text class="data-value">{{latestData.bodyFatRate || '--'}}%</text>
        </view>

        <!-- èº«é«˜ -->
        <view class="data-item">
          <text class="data-label">èº«é«˜</text>
          <text class="data-value">{{latestData.height || '--'}} cm</text>
        </view>
      </view>

      <!-- å›´åº¦æ•°æ® -->
      <view class="measurements-section" wx:if="{{latestData.measurements}}">
        <text class="section-title">å›´åº¦æ•°æ®</text>
        <view class="measurements-grid">
          <view class="measurement-item">
            <text class="measurement-label">èƒ¸å›´</text>
            <text class="measurement-value">{{formatMeasurement(latestData.measurements.chest)}}</text>
          </view>
          <view class="measurement-item">
            <text class="measurement-label">è…°å›´</text>
            <text class="measurement-value">{{formatMeasurement(latestData.measurements.waist)}}</text>
          </view>
          <view class="measurement-item">
            <text class="measurement-label">è‡€å›´</text>
            <text class="measurement-value">{{formatMeasurement(latestData.measurements.hip)}}</text>
          </view>
          <view class="measurement-item">
            <text class="measurement-label">å¤§è…¿å›´</text>
            <text class="measurement-value">{{formatMeasurement(latestData.measurements.thigh)}}</text>
          </view>
          <view class="measurement-item">
            <text class="measurement-label">è‡‚å›´</text>
            <text class="measurement-value">{{formatMeasurement(latestData.measurements.arm)}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <view class="stats-card">
      <view class="stat-item">
        <text class="stat-value">{{totalRecords}}</text>
        <text class="stat-label">æ€»è®°å½•æ•°</text>
      </view>
      <view class="stat-item" wx:if="{{weightChange !== 0}}">
        <text class="stat-value {{weightChange > 0 ? 'increase' : 'decrease'}}">
          {{weightChange > 0 ? '+' : ''}}{{weightChange.toFixed(1)}}
        </text>
        <text class="stat-label">ä½“é‡å˜åŒ–(kg)</text>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!latestData}}">
      <text class="empty-icon">ğŸ“Š</text>
      <text class="empty-text">è¿˜æ²¡æœ‰èº«ä½“æ•°æ®</text>
      <text class="empty-hint">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è®°å½•ç¬¬ä¸€æ¬¡æ•°æ®</text>
    </view>
  </view>

  <!-- å†å²è®°å½•é¡µé¢ -->
  <view class="tab-content" wx:if="{{currentTab === 'history'}}">
    <view class="history-list">
      <view class="history-item"
            wx:for="{{historyList}}"
            wx:key="_id">

        <view class="history-header">
          <text class="history-date">{{item.date}}</text>
          <text class="history-delete"
                bindtap="deleteRecord"
                data-id="{{item._id}}"
                data-date="{{item.date}}">åˆ é™¤</text>
        </view>

        <view class="history-body">
          <view class="history-data-row">
            <text class="history-label">ä½“é‡</text>
            <text class="history-value">{{item.weight || '--'}} kg</text>
          </view>
          <view class="history-data-row">
            <text class="history-label">BMI</text>
            <text class="history-value">{{calculateBMI(item.weight, item.height) || '--'}}</text>
          </view>
          <view class="history-data-row">
            <text class="history-label">ä½“è„‚ç‡</text>
            <text class="history-value">{{item.bodyFatRate || '--'}}%</text>
          </view>

          <!-- å›´åº¦æ•°æ® -->
          <view class="history-measurements" wx:if="{{item.measurements}}">
            <view class="measurement-tag" wx:if="{{item.measurements.chest}}">
              èƒ¸ {{item.measurements.chest}}
            </view>
            <view class="measurement-tag" wx:if="{{item.measurements.waist}}">
              è…° {{item.measurements.waist}}
            </view>
            <view class="measurement-tag" wx:if="{{item.measurements.hip}}">
              è‡€ {{item.measurements.hip}}
            </view>
            <view class="measurement-tag" wx:if="{{item.measurements.thigh}}">
              å¤§è…¿ {{item.measurements.thigh}}
            </view>
            <view class="measurement-tag" wx:if="{{item.measurements.arm}}">
              è‡‚ {{item.measurements.arm}}
            </view>
          </view>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{historyList.length === 0}}">
        <text class="empty-icon">ğŸ“‹</text>
        <text class="empty-text">è¿˜æ²¡æœ‰å†å²è®°å½•</text>
      </view>
    </view>
  </view>

  <!-- æ–°å¢æ•°æ®è¡¨å• -->
  <view class="add-form-modal" wx:if="{{isAdding}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">è®°å½•èº«ä½“æ•°æ®</text>
        <text class="modal-close" bindtap="cancelAdd">Ã—</text>
      </view>

      <scroll-view class="modal-body" scroll-y>
        <!-- æ—¥æœŸé€‰æ‹© -->
        <view class="form-item">
          <text class="form-label">æ—¥æœŸ</text>
          <picker mode="date"
                  value="{{formData.date}}"
                  bindchange="bindDateChange">
            <view class="picker-view">
              <text class="picker-text">{{formData.date || 'é€‰æ‹©æ—¥æœŸ'}}</text>
            </view>
          </picker>
        </view>

        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <view class="form-section">
          <text class="section-title">åŸºæœ¬ä¿¡æ¯</text>

          <view class="form-row">
            <text class="field-label">ä½“é‡ (kg)</text>
            <input class="form-input"
                   type="digit"
                   placeholder="è¾“å…¥ä½“é‡"
                   value="{{formData.weight}}"
                   bindinput="updateFormData"
                   data-field="weight" />
          </view>

          <view class="form-row">
            <text class="field-label">èº«é«˜ (cm)</text>
            <input class="form-input"
                   type="digit"
                   placeholder="è¾“å…¥èº«é«˜"
               value="{{formData.height}}"
               bindinput="updateFormData"
               data-field="height" />
          </view>

          <view class="form-row">
            <text class="field-label">ä½“è„‚ç‡ (%)</text>
            <input class="form-input"
                   type="digit"
                   placeholder="è¾“å…¥ä½“è„‚ç‡"
                   value="{{formData.bodyFatRate}}"
                   bindinput="updateFormData"
                   data-field="bodyFatRate" />
          </view>
        </view>

        <!-- å›´åº¦æ•°æ® -->
        <view class="form-section">
          <text class="section-title">å›´åº¦æ•°æ® (cm)</text>

          <view class="form-row">
            <text class="field-label">èƒ¸å›´</text>
            <input class="form-input"
                   type="digit"
                   placeholder="è¾“å…¥èƒ¸å›´"
                   value="{{formData.chest}}"
                   bindinput="updateFormData"
                   data-field="chest" />
          </view>

          <view class="form-row">
            <text class="field-label">è…°å›´</text>
            <input class="form-input"
                   type="digit"
                   placeholder="è¾“å…¥è…°å›´"
                   value="{{formData.waist}}"
                   bindinput="updateFormData"
                   data-field="waist" />
          </view>

          <view class="form-row">
            <text class="field-label">è‡€å›´</text>
            <input class="form-input"
                   type="digit"
                   placeholder="è¾“å…¥è‡€å›´"
                   value="{{formData.hip}}"
                   bindinput="updateFormData"
                   data-field="hip" />
          </view>

          <view class="form-row">
            <text class="field-label">å¤§è…¿å›´</text>
            <input class="form-input"
                   type="digit"
                   placeholder="è¾“å…¥å¤§è…¿å›´"
                   value="{{formData.thigh}}"
                   bindinput="updateFormData"
                   data-field="thigh" />
          </view>

          <view class="form-row">
            <text class="field-label">è‡‚å›´</text>
            <input class="form-input"
                   type="digit"
                   placeholder="è¾“å…¥è‡‚å›´"
                   value="{{formData.arm}}"
                   bindinput="updateFormData"
                   data-field="arm" />
          </view>
        </view>
      </scroll-view>

      <view class="modal-footer">
        <button class="cancel-btn" bindtap="cancelAdd">å–æ¶ˆ</button>
        <button class="save-btn" bindtap="saveData">ä¿å­˜</button>
      </view>
    </view>
  </view>
</view>
